function inflow = AorticFlowWave(params)
% Generate an aortic flow wave
%    Inputs:    HR
%               SV
%               Wave type
%               Amount of reverse flow
%               Sampling Frequency (in Hz)
%
%    Outputs:   Aortic flow wave

%% ==== Setup params
if nargin < 1
    params = setup_params;
else
    params = setup_params(params);
end
params.file_path = '/Users/petercharlton/Google Drive/Work/Code/AorticFlowWave/AorticFlowWave manual/Figures/';

%% ==== Determine appropriate left ventricular ejection time (LVET)
params.LVET = calc_lvet(params);

%% ==== Find Template Flow Wave
template_flow = create_template_inflow_waveform(params);

%% ==== Find Adjusted Flow Wave
inflow = adjust_template_flow(params, template_flow);

%% ==== Adjust Sampling Frequency
inflow = adjust_sampling_frequency(params, inflow);

%% ==== Plot Figures
plot_figures(params, template_flow, inflow);    

end

function params = setup_params(params)

% if no parameters were specified then create a variable to store them in
if ~exist('params', 'var')
    params = struct;
end

% shut figures unless plotting multiple flow waveforms
if ~sum(strcmp(fieldnames(params),'plot_multiple'))
    close all
elseif params.plot_multiple
    figHandles = findobj('Type', 'figure');
    if ~isempty(figHandles)
        close(figHandles(2));
    end
    clear figHandles
end

% if CO and HR have been specified, but not SV, then calculate SV
curr_params = fieldnames(params);
if sum(strcmp(curr_params, 'HR')) && sum(strcmp(curr_params, 'CO')) && ~sum(strcmp(curr_params, 'SV'))
    params.SV = 1000*params.CO / params.HR;
end

% identify any missing parameters
curr_params = fieldnames(params);
req_params = {'HR', 'SV', 'wave_type', 'rev_flow', 'fs', 'contractility_const','do_plot','save_plot', 'plot_multiple', 'plot_name'};
missing_params = setxor(curr_params, req_params); clear curr_params req_params

% If any parameters are missing then insert the baseline values for them
for param_no = 1 : length(missing_params)
    
    % identify the current missing parameter
    curr_missing_param = missing_params{param_no};
    
    % specify the baseline value of this parameter
    switch curr_missing_param
        case 'HR'
            val = 75;       % in bpm
        case 'SV'
            val = 83;       % im ml
        case 'wave_type'
            val = 'elderly';  % either 'young' or 'avg' or 'elderly'
        case 'rev_flow'
            val = 1;        % between 0 and 1 - the proportion of reverse flow to include
        case 'fs'
            val = 1000;     % in Hz
        case 'contractility_const'
            val = 1;        % a multiplication factor applied to the time of the systolic peak
        case 'do_plot'
            val = true;     % whether or not to plot the generated wave
        case 'save_plot'
            val = false;
        case 'plot_multiple'
            val = false;
        case 'plot_name'
            val = 'temp';
    end
            
    % insert this baseline value
    eval(['params.' curr_missing_param ' = val;'])
    
    clear val
    
end

end

function LVET = calc_lvet(params)

% use the function provided in the following article to derive LVET:
%
%    Weissler et al, "Relationships between left ventricular ejection time,
%    stroke volume, and heart rate in normal individuals and patients with
%    cardiovascular disease", American Heart Journal, vol. 62, 1961.
%    DOI: 10.1016/0002-8703(61)90403-3 

% Function:
%    LVET = 0.266 + 0.0011*(SV - 82) - 0.0009*(HR - 73)
% where LVET is in secs, SV [ml] is stroke volume, and HR [bpm] is heart rate.

% If a LVET has been specified as an input, then take this
if ~sum(strcmp(fieldnames(params), 'lvet'))
   
    % otherwise, calculate using this formula
    LVET = 0.266 + 0.0011*(params.SV - 82) - 0.0009*(params.HR - 73);   % in secs
end

end

function template_flow = create_template_inflow_waveform(params)

%% === Setup constants

% timings
template_flow.T = 1;
template_flow.ti_0   = 0.020*template_flow.T; %Time of inflection point in systolic increase
template_flow.tmax_0 = 0.085*template_flow.T; %Time of systolic peak
template_flow.ti2_0  = 0.22*template_flow.T;  %0.150; Time of inflection point in systolic decrease (old only)
template_flow.ts_0   = 0.290*template_flow.T; %Time of start of dicrotic notch
template_flow.tmin_0 = 0.300*template_flow.T; %Time of minimum flow during dicrotic notch
template_flow.td_0   = 0.330*template_flow.T; %Time of start of diastole

% flows
template_flow.Qmax = 1;    %Systolic peak flow
template_flow.Qi   = 0.32; %Flow at inflection point
template_flow.Qi2  = 0.4;  %0.75; Flow at inflection point in systolic decrease (old)
template_flow.Qmin = -0.1; %Minimum flow during dicrotic notch

% round timings to  right sizes of time vector
ti   = round(template_flow.ti_0  *1000)./1000;
tmax = round(template_flow.tmax_0*1000)./1000;
ti2  = round(template_flow.ti2_0 *1000)./1000;
ts   = round(template_flow.ts_0  *1000)./1000;
tmin = round(template_flow.tmin_0*1000)./1000;
td   = round(template_flow.td_0  *1000)./1000;

% time step
dt = 1/1000;

%% === Calculate template using Marie's piecewise polynomial

switch params.wave_type   % young, avg, or elderly
    case 'young'
        template_flow.age = 'young';
        template_flow.v = Get_parametric_young(dt, template_flow.Qi, template_flow.Qmax, template_flow.Qmin, ti, tmax, tmin, ts, td);
    case 'avg'
        template_flow.age = 'avg';
        young = Get_parametric_young(dt, template_flow.Qi, template_flow.Qmax, template_flow.Qmin, ti, tmax, tmin, ts, td);
        elderly = Get_parametric_old(dt, template_flow.Qi, template_flow.Qmax, template_flow.Qmin, template_flow.Qi2, ti, tmax, tmin, ti2, ts, td);
        template_flow.v = (young+elderly)./2; clear young elderly
    case 'elderly'
        template_flow.age = 'elderly';
        template_flow.v = Get_parametric_old(dt, template_flow.Qi, template_flow.Qmax, template_flow.Qmin, template_flow.Qi2, ti, tmax, tmin, ti2, ts, td);
    case 'impulse'
        template_flow.age = 'impulse';
        durn_of_impulse = 0.05*template_flow.T;
        durn_of_impulse_samples = round(durn_of_impulse*(1/dt));
        durn_of_beat = template_flow.T;
        durn_of_beat_samples = round(durn_of_beat*(1/dt));
        template_flow.v = [0, ones(1,durn_of_impulse_samples), zeros(1,durn_of_beat_samples - durn_of_impulse_samples-1)];
end
template_flow.t = 0:dt:((length(template_flow.v)-1)*dt);

end

function inflow = adjust_template_flow(params, template_flow)
%% === Adjust template to give desired timings

% Desired waveform specifications
inflow.HR           = params.HR;           % Heart rate (bpm)
inflow.T            = 60/params.HR;
inflow.SV           = params.SV;
inflow.CO           = inflow.HR*params.SV/1000;  % Cardiac output (l/s)
inflow.reverseflow  = params.rev_flow;
inflow.t_dic        = params.LVET;
inflow.t_sys        = params.contractility_const * template_flow.tmax_0;  % constant calculated from ORourke's template
inflow.t_dia        = 1.138 * inflow.t_dic;   % constant calculated from ORourke's template

% extra setup
dt = 1/params.fs;

if ~strcmp(params.wave_type, 'impulse')
    
    % Find sytolic upslope
    deb = 1; [~, fin] = max(template_flow.v);
    sys_upslope.v = template_flow.v(deb:fin);
    sys_upslope.t = linspace(0, inflow.t_sys, length(sys_upslope.v));
    
    % Find systolic downslope
    [~, temp] = max(template_flow.v); deb = temp+1; clear temp
    fin = find(template_flow.v(1:end-1) > 0 & template_flow.v(2:end) <= 0); fin = fin(1);
    sys_downslope.v = template_flow.v(deb:fin);
    sys_downslope.t = linspace(sys_upslope.t(end)+dt, inflow.t_dic, length(sys_downslope.v));
    
    % Find reverse flow
    deb = find(template_flow.v(1:end-1) > 0 & template_flow.v(2:end) <= 0); deb = deb(1)+1;
    fin = find(template_flow.v ~= 0, 1, 'last');
    reverse.v = inflow.reverseflow*template_flow.v(deb:fin);
    reverse.t = linspace(sys_downslope.t(end)+dt, inflow.t_dia, length(reverse.v));
    
    % Find diastolic flat line
    no_els = round((inflow.T - (inflow.t_dia+dt))/dt);
    diastolic.t = linspace(inflow.t_dia+dt, inflow.T, no_els);
    diastolic.v = zeros(size(diastolic.t));
    
    % concatenate to give waveform
    mod_flow.t = [sys_upslope.t, sys_downslope.t, reverse.t, diastolic.t];
    mod_flow.v = [sys_upslope.v, sys_downslope.v, reverse.v, diastolic.v];
    
    % resample to give constant fs, without irregular spacing at joins
    no_els = round((mod_flow.t(end) - mod_flow.t(1))/dt);
    inflow.t = linspace(mod_flow.t(1), mod_flow.t(end),no_els);
    inflow.v = interp1(mod_flow.t, mod_flow.v, inflow.t);
    
else
    inflow.v = template_flow.v;
    inflow.t = template_flow.t;
end

% Scale to give desired stroke volume
scale_factor = params.SV/(sum(inflow.v)*dt);
inflow.v = inflow.v*scale_factor;  % flow is now in ml/s

% Convert to required units
CO_in_m3_per_sec = inflow.CO/(60*1000);
inflow.v = inflow.v./mean(inflow.v).*CO_in_m3_per_sec;

% Update inflow parameters with final values
CO = mean(inflow.v);
inflow.CO_m3_per_sec = CO; % Cardiac output [m3/s]

end

function Qtot_old = Get_parametric_old(dt, Qi, Qmax, Qmin,Qi2, ti,tmax,tmin,ti2, ts, td)


%% Q2 = fourth order (for old wave); no horizontal slope at t=0

% 15 unknowns
%LHS_old
% [P14 P13 P12 P11 P10     P24 P23 P22 P21 P20    P34 P33 P32 P31 P30]
LHS_O = [
    tmax^4      tmax^3      tmax^2      tmax^1  1       0 0 0 0 0    0 0 0 0 0;  %Q1(tmax) = Qmax
    0           0           0           0       1       0 0 0 0 0    0 0 0 0 0;  %Q1(0) = 0
%    0           0           0           1       0      0 0 0 0 0    0 0 0 0 0;  %Q1'(0) = 0
    4*tmax^3    3*tmax^2    2*tmax^1    1       0       0 0 0 0 0    0 0 0 0 0;  %Q1'(tmax) = 0
    4*3*ti^2    3*2*ti      2           0       0       0 0 0 0 0    0 0 0 0 0;  %Q1''(ti) =0
    ti^4        ti^3        ti^2        ti      1       0 0 0 0 0    0 0 0 0 0;  %Q1(ti) = Qi
    
    0           0           0           0       0       tmax^4      tmax^3     tmax^2   tmax    1       0 0 0 0 0; %Q2(tmax)=Qmax
    0           0           0           0       0       4*tmax^3    3*tmax^2   2*tmax   1       0       0 0 0 0 0; %Q2'(tmax)=0
    0           0           0           0       0       ti2^4       ti2^3      ti2^2    ti2     1       0 0 0 0 0; %Q2(ti2) = Qi2
    0           0           0           0       0       4*3*ti2^2   3*2*ti2    2        0       0       0 0 0 0 0; %Q2'(tmax)=0
    
    0           0           0           0       0       ts^4        ts^3       ts^2     ts      1       -ts^4      -ts^3     -ts^2    -ts  -1; %Q2(ts)=Q3(ts)
    0           0           0           0       0       4*ts^3      3*ts^2     2*ts     1       0       -4*ts^3    -3*ts^2   -2*ts    -1   0;  %Q2'(ts)=Q3'(ts)  
    0 0 0 0 0   0 0 0 0 0     td^4        td^3        td^2    td      1; %Q3(td) = 0
    0 0 0 0 0   0 0 0 0 0     4*td^3      3*td^2      2*td    1       0; %Q3'(td)=0
    0 0 0 0 0   0 0 0 0 0     tmin^4      tmin^3      tmin^2  tmin    1; %Q3(tmin) = Qmin
    0 0 0 0 0   0 0 0 0 0     4*tmin^3    3*tmin^2    2*tmin  1       0  %Q3'(tmin) = 0
    ];

%RHS
RHS_O = [
    Qmax;
    0;
%     0; %Q1'(0) = 0
    0;
    0;
    Qi;
    Qmax;
    0;
    Qi2;
    0;
    0;
    0;
    0;
    0;
    Qmin;
    0
];

%Solve system A*X=B: x = A\B;
clear X;
X = LHS_O\RHS_O;


%% Equation of flow curve solution - OLD
dt=1e-3;
%Q1, t1
t1=[0:dt:tmax];
Q1 = X(1).*t1.^4 + X(2).*t1.^3 + X(3).*t1.^2 +X(4).*t1 + X(5);

%Q2,t2
t2=[tmax+dt:dt:ts];
Q2 = X(6).*t2.^4 + X(7).*t2.^3 + X(8).*t2.^2 + X(9).*t2 + X(10);

%Q3,t3
t3 = [ts+dt:dt:td];
Q3 = X(11).*t3.^4 + X(12).*t3.^3 + X(13).*t3.^2 + X(14).*t3 + X(15);

%Q4, t4
t4 = [td+dt:dt:1.0];
Q4 = t4.*0;

Qtot_old = [Q1, Q2, Q3, Q4]; 

end

function Qtot_young = Get_parametric_young(dt, Qi, Qmax, Qmin, ti,tmax,tmin, ts, td)


%% Q2:second order, no horizontal slope = 0 at t=0 - YOUNG wave

% [P14 P13 P12 P11 P10     P22 P21 P20    P34 P33 P32 P31 P30]
LHS_Y = [
    tmax^4      tmax^3      tmax^2      tmax^1  1        0 0 0    0 0 0 0 0;  %Q1(tmax) = Qmax
    0           0           0           0       1        0 0 0    0 0 0 0 0;  %Q1(0) = 0
%    0           0           0           1       0        0 0 0    0 0 0 0 0;  %Q1'(0) = 0
    4*tmax^3    3*tmax^2    2*tmax^1    1       0        0 0 0    0 0 0 0 0;  %Q1'(tmax) = 0
    4*3*ti^2    3*2*ti      2           0       0        0 0 0    0 0 0 0 0;  %Q1''(ti) =0
    ti^4        ti^3        ti^2        ti      1        0 0 0    0 0 0 0 0;  %Q1(ti) = Qi  
    0           0           0           0       0          tmax^2   tmax 1       0 0 0 0 0; %Q2(tmax)=Qmax
    0           0           0           0       0          2*tmax   1    0       0 0 0 0 0; %Q2'(tmax)=0
    0           0           0           0       0          ts^2     ts   1       -ts^4      -ts^3     -ts^2    -ts -1; %Q2(ts)=Q3(ts)
    0           0           0           0       0           2*ts     1    0       -4*ts^3    -3*ts^2   -2*ts    -1  0;  %Q2'(ts)=Q3'(ts)  
    0 0 0 0 0    0 0 0     td^4        td^3        td^2    td      1; %Q3(td) = 0
    0 0 0 0 0    0 0 0     4*td^3      3*td^2      2*td    1       0; %Q3'(td)=0
    0 0 0 0 0    0 0 0     tmin^4      tmin^3      tmin^2  tmin    1; %Q3(tmin) = Qmin
    0 0 0 0 0    0 0 0     4*tmin^3    3*tmin^2    2*tmin  1       0  %Q3'(tmin) = 0
    ];

%RHS
RHS_Y = [
    Qmax;
    0;
%     0; %Q1'(0) = 0
    0;
    0;
    Qi;
    Qmax;
    0;
    0;
    0;
    0;
    0;
    Qmin;
    0
];

%Solve system A*X=B: x = A\B;
X = LHS_Y\RHS_Y;

%% Equation of flow curve solution - YOUNG
%Q1, t1
t1=[0:dt:tmax];
Q1 = X(1).*t1.^4 + X(2).*t1.^3 + X(3).*t1.^2 +X(4).*t1 + X(5);

%Q2,t2
t2=[tmax+dt:dt:ts];
Q2 = X(6).*t2.^2 + X(7).*t2 + X(8);

%Q3,t3
t3 = [ts+dt:dt:td];
Q3 = X(9).*t3.^4 + X(10).*t3.^3 + X(11).*t3.^2 + X(12).*t3 + X(13);

%Q4, t4
t4 = [td+dt:dt:1.0];
Q4 = t4.*0;

Qtot_young = [Q1, Q2, Q3, Q4]; 

end

function inflow = adjust_sampling_frequency(params, inflow)

old_t = inflow.t;
inflow.t = linspace(0, inflow.T, params.fs);
inflow.v = interp1(old_t, inflow.v, inflow.t);


end

function plot_figures(params, template_flow, inflow)

% plot figure if requested
if params.do_plot
    
    % Comparison with O'Rourke waveforms
    young.v = [-0.00353853485248884;-0.00300004332192523;-0.00187893687995495;-0.000149772559892562;0.00284581726811940;0.00666226227093532;0.0113802365377117;0.0183717454403674;0.0262834120348308;0.0352098947277217;0.0464086123987350;0.0588614998050513;0.0727894987653251;0.0882207685309535;0.104605120651562;0.122189490100940;0.141017198804315;0.160262964086124;0.179946280812719;0.200636832300827;0.221461681757137;0.242256205865789;0.263397305376251;0.284776675475458;0.306524281939089;0.328293549365334;0.350041155828965;0.371767101329983;0.393276437204869;0.414742451154529;0.436143482216350;0.457717800979076;0.479075510115670;0.499740068448642;0.519949746566737;0.539812849283022;0.559112766971364;0.577416280379500;0.595373218385825;0.613308495429537;0.630398994931335;0.646904648442577;0.662565524411905;0.678009790755101;0.693150803621713;0.707447038946411;0.721526664644977;0.735497985530477;0.749447645453364;0.763007408049214;0.776307239093705;0.789238833773773;0.802127106528614;0.814928735433003;0.827210501234675;0.839405623185894;0.851514101286661;0.863016072434259;0.873543300264264;0.883399038253260;0.893081488541351;0.902482346315470;0.911579950613005;0.919507862929429;0.926937573105749;0.933912403067192;0.940302387038080;0.946475761382836;0.952410865138847;0.957241259801586;0.961768400987740;0.966035610622536;0.970172854481653;0.973963522938959;0.977385955031842;0.980418489797687;0.983364380713079;0.986223627778018;0.988476367889789;0.990664125113720;0.992830221375038;0.994476454533639;0.995667807477364;0.996360958280986;0.997400684486419;0.998288783953559;0.998873629944115;0.998981934757181;0.999263527271152;0.999891695186934;1;0.999891695186934;0.999523458822510;0.998722003205822;0.997963869514361;0.997335701598579;0.996945804271542;0.996425941168826;0.995559502664298;0.994519776458866;0.993436728328207;0.992245375384482;0.991140666291210;0.989970974310098;0.988671316553308;0.987025083394706;0.985248884460426;0.983386041675692;0.981566520816185;0.979898626694970;0.978620629900793;0.977169345405710;0.975523112247108;0.973551964649309;0.971342546462765;0.969133128276220;0.967443573192393;0.965580730407659;0.963609582809860;0.961616774249448;0.959515660875969;0.957392886539878;0.955335095091626;0.953190659792921;0.950959580643764;0.948555213793701;0.946215829831478;0.943941428757094;0.941905298271455;0.939609236234458;0.937139886496556;0.934497249057748;0.932006238357233;0.929623532469783;0.927782350647663;0.925421305722826;0.922648702508340;0.919637828705108;0.916800242602781;0.914114283238747;0.912143135640948;0.909717107828272;0.906836199800719;0.903782004072261;0.900922757007321;0.898280119568514;0.896027379456743;0.893406402980549;0.890395529177317;0.887233028635793;0.884460425421306;0.882186024346922;0.879781657496859;0.877009054282372;0.873759909890396;0.870424121647966;0.867478230732574;0.865052202919898;0.862344582593250;0.859333708790019;0.855911276697136;0.853095351557423;0.850236104492484;0.847225230689252;0.844106052072954;0.840986873456656;0.837824372915132;0.834271975046571;0.830741238140623;0.827405449898194;0.824199627431443;0.820777195338561;0.816769917255123;0.813174197461335;0.809556816704934;0.805701165359789;0.801260668024087;0.796646882987480;0.791989776025647;0.787657583503011;0.783390373868215;0.778906554607287;0.773837889355803;0.768595936403414;0.763483949226704;0.758588571676125;0.753541567387255;0.747519819780791;0.741563055062167;0.735692934193996;0.730082744877182;0.724125980158558;0.718017588701642;0.711909197244726;0.705714161937357;0.699454143742148;0.693150803621713;0.686890785426504;0.680630767231296;0.674197461335182;0.667872460252134;0.661699085907378;0.655850626001820;0.649828878395356;0.643720486938440;0.637612095481523;0.631460382099380;0.625308668717238;0.619590174587359;0.613676731793961;0.607568340337045;0.601308322141836;0.595134947797080;0.589048217302777;0.583438027985964;0.577567907117792;0.571437854698263;0.565286141316120;0.558982801195685;0.552527834336958;0.546549408655721;0.540332712385738;0.533769440713945;0.527747693107482;0.521487674912273;0.514902742277867;0.508751028895724;0.502382705887450;0.495667807477364;0.489537755057835;0.483169432049560;0.476389550751635;0.470216176406880;0.463847853398605;0.457046311138067;0.450721310055019;0.444331326084131;0.437681410561885;0.431443053329290;0.425053069358402;0.418164883247412;0.411818221201750;0.405428237230863;0.398734999783390;0.392215050036824;0.385695100290257;0.379066845730624;0.372308625395313;0.365507083134775;0.358640557986397;0.351644067062340;0.344604254213057;0.337521119438548;0.330849542953689;0.324069661655764;0.316488324741151;0.309361868041416;0.302322055192133;0.295000649828878;0.287397651951653;0.279664688298748;0.271910063683230;0.264220421955552;0.256465797340034;0.248169648659186;0.240220075380150;0.232508772689858;0.224840791924793;0.216804574795304;0.208482432959321;0.199997833903739;0.191112507039813;0.181999740068449;0.173155569033488;0.163912836286445;0.154388511025430;0.144883680630767;0.135060434085691;0.124938266256552;0.113897673612615;0.102863579257462;0.0918121561322185;0.0800329246631720;0.0681518866698436;0.0561798726335398;0.0445024476887753;0.0326105792141403;0.0205111987176710;0.00896438937746394;-0.00231772299961010;-0.0133184594723390;-0.0244682233678465;-0.0353788502361045;-0.0459992202053459;-0.0549430316683273;-0.0632478447342200;-0.0708486765151843;-0.0768357665814669;-0.0818741064852922;-0.0857622492743577;-0.0882900836113157;-0.0901572585885717;-0.0912338084304467;-0.0908287484295802;-0.0897218732400468;-0.0877615561235541;-0.0853311961183555;-0.0823289867001689;-0.0784235151410129;-0.0741173157735130;-0.0699020924489884;-0.0660247801412295;-0.0618182212017502;-0.0576636485725426;-0.0537885023610449;-0.0506346662045661;-0.0473920201013733;-0.0435017112160464;-0.0394662738812113;-0.0355088160117836;-0.0318719403890309;-0.0281267599532123;-0.0243707490360872;-0.0206844864185764;-0.0175310834813499;-0.0146718364164103;-0.0121678291383269;-0.00968786552874410;-0.00736710999436815;-0.00562491877139020;-0.00442793397738595;-0.00345405709829745;-0.00240739938482866;-0.00180314517177143;-0.00153868647922714;-0.00191829484902309;-0.00203411601611576;-0.00204061430489971;-0.00223519473205389;-0.00265195165273145;-0.00312026166442837;-0.00302127106528614;-0.00297513321492007;-0.00296690204912706;-0.00299722739678551;-0.00299332842351514;-0.00296971797426678;-0.00299939349304683;-0.00300762465883984;-0.00300004332192523;-0.00299917688342070;-0.00298921284061864;-0.00297340033791102;-0.00299831044491617;-0.00299852705454230;-0.00297686609192913;-0.00300112637005589;-0.00300459212407399;-0.00298747996360958;-0.00298509725772213;-0.00297751592080752;-0.00296451934323961;-0.00299376164276740;-0.00299679417753325;-0.00296820170688385;-0.00299376164276740;-0.00300979075510116;-0.00300979075510116;-0.00299896027379457;-0.00298379759996534;-0.00296430273361348;-0.00298986266949703;-0.00300480873370013;-0.00299722739678551;-0.00301672226313737;-0.00303665034874150;-0.00305116319369233;-0.00303318459472339;-0.00300740804921371;-0.00297708270155526;-0.00297729931118139;-0.00298141489407789;-0.00298293116146082;-0.00298812979248798;-0.00298899623099251;-0.00297903218819044;-0.00295303903305463;-0.00292141402763939;-0.00288653987783217;-0.00289412121474678;-0.00290668457306243;-0.00290105272278300;-0.00290473508642724;-0.00291643200623836;-0.00294415803838323;-0.00294199194212191;-0.00292877875492787;-0.00291339947147251;-0.00291859810249968;-0.00293397738595503;-0.00295780444482953;-0.00294957327903652;-0.00293267772819824;-0.00293787635922540;-0.00292877875492787;-0.00291469912922930;-0.00291036693670667;-0.00290191916128753;-0.00289368799549452;-0.00289910323614781;-0.00289867001689555;-0.00289888662652168;-0.00292682926829268;-0.00292509639128363;-0.00290581813455790;-0.00289585409175584;-0.00290040289390461;-0.00291664861586449;-0.00295368886193302;-0.00295997054109085;-0.00294567430576615;-0.00297166746090196;-0.00297426677641554;-0.00295845427370792;-0.00295303903305463;-0.00294199194212191;-0.00292682926829268;-0.00295152276567171;-0.00295758783520340;-0.00294545769614002;-0.00297275050903262;-0.00297664948230299;-0.00295542173894208;-0.00294242516137417;-0.00293484382445956;-0.00293311094745051;-0.00296040376034311;-0.00296386951436122;-0.00293592687259022;-0.00296365290473509;-0.00297751592080752;-0.00296690204912706;-0.00296646882987480;-0.00296170341809990;-0.00294849023090586;-0.00297275050903262;-0.00298076506519950;-0.00295477191006368;-0.00297469999566781;-0.00298661352510506;-0.00297145085127583;-0.00297015119351904;-0.00296733526837933;-0.00295607156782047;-0.00297881557856431;-0.00299029588874930;-0.00296235324697830;-0.00298119828445176;-0.00299939349304683;-0.00298834640211411;-0.00298119828445176;-0.00297296711865875;-0.00295953732183858;-0.00298249794220855;-0.00300372568556947;-0.00298683013473119;-0.00300654161070918;-0.00303318459472339;-0.00304184897976866;-0.00303448425248018;-0.00301845514014643;-0.00299224537538448;-0.00299744400641165;-0.00301174024173634;-0.00300719143958758;-0.00301585582463285;-0.00302538664818265;-0.00300870770697050;-0.00298834640211411;-0.00296473595286575;-0.00293549365333795;-0.00293809296885154;-0.00295368886193302;-0.00293332755707664;-0.00293874279772993;-0.00295953732183858;-0.00297968201706884;-0.00298098167482563;-0.00296885153576225;-0.00294784040202747;-0.00295108954641944;-0.00297188407052809;-0.00298444742884374;-0.00298379759996534;-0.00297253389940649;-0.00296495256249188;-0.00295368886193302;-0.00293939262660833;-0.00292986180305853;-0.00292444656240523;-0.00292249707577005;-0.00291253303296799;-0.00291274964259412;-0.00292358012390071;-0.00295043971754105;-0.00295867088333406;-0.00294502447688775;-0.00292726248754495;-0.00292379673352684;-0.00293852618810380;-0.00295910410258632;-0.00296235324697830;-0.00294199194212191;-0.00295260581380237;-0.00294978988866265;-0.00292293029502231;-0.00290365203829658;-0.00288480700082312;-0.00286574535372352;-0.00287635922540398;-0.00288437378157085;-0.00288047480830048;-0.00290105272278300;-0.00290928388857601;-0.00288610665857991;-0.00287181042325521;-0.00286899449811550;-0.00288675648745830;-0.00292033097950873;-0.00294199194212191;-0.00292682926829268;-0.00294524108651388;-0.00296127019884764;-0.00294784040202747;-0.00294264177100030;-0.00293765974959927;-0.00292552961053589;-0.00294415803838323;-0.00295997054109085;-0.00293376077632890;-0.00294437464800936;-0.00295997054109085;-0.00294220855174804;-0.00293787635922540;-0.00293722653034701;-0.00292791231642334;-0.00294437464800936;-0.00296321968548282;-0.00293571026296409;-0.00294762379240133;-0.00297296711865875;-0.00296278646623056;-0.00295932071221245;-0.00295802105445566;-0.00294502447688775;-0.00295823766408179;-0.00298163150370402;-0.00295520512931595;-0.00296018715071698;-0.00298314777108695;-0.00297773253043365;-0.00296993458389291;-0.00295975393146471;-0.00293787635922540;-0.00294155872286964;-0.00296408612398735;-0.00295390547155916;-0.00296321968548282;-0.00298834640211411;-0.00297275050903262;-0.00296083697959537;-0.00295238920417623;-0.00293830957847767;-0.00294784040202747;-0.00298184811333016;-0.00296321968548282;-0.00296863492613612;-0.00300264263743881;-0.00301195685136247;-0.00301282328986700;-0.00300459212407399;-0.00298423081921761;-0.00298271455183468;-0.00300740804921371;-0.00300784126846597;-0.00300849109734437;-0.00301195685136247;-0.00299766061603778;-0.00298423081921761;-0.00297491660529394;-0.00296386951436122;-0.00296018715071698;-0.00296971797426678;-0.00295152276567171;-0.00294459125763549;-0.00296776848763159;-0.00298596369622666;-0.00299419486201967;-0.00298379759996534;-0.00296386951436122;-0.00295563834856821;-0.00297968201706884;-0.00299116232725382;-0.00299506130052419;-0.00298791318286185;-0.00297838235931205;-0.00296733526837933;-0.00295412208118529;-0.00294307499025257;-0.00293549365333795;-0.00293657670146861;-0.00294090889399125;-0.00294545769614002;-0.00294654074427068;-0.00295520512931595;-0.00295845427370792;-0.00292682926829268;-0.00289845340726942;-0.00287939176016982;-0.00289758696876489;-0.00291881471212581;-0.00293614348221635;-0.00292358012390071;-0.00293029502231079;-0.00294220855174804;-0.00291924793137807;-0.00290061950353074;-0.00288524022007538;-0.00287332669063813;-0.00287982497942209;-0.00289737035913876;-0.00290213577091366;-0.00292119741801326;-0.00294762379240133;-0.00292986180305853;-0.00291773166399515;-0.00290971710782827;-0.00290126933240913;-0.00291123337521119;-0.00293549365333795;-0.00291253303296799;-0.00291686522549062;-0.00294697396352294;-0.00293722653034701;-0.00293137807044145;-0.00292942858380626;-0.00291881471212581;-0.00292661265866655;-0.00295498851968982;-0.00293116146081532;-0.00292812892604947;-0.00295238920417623;-0.00293657670146861;-0.00292726248754495;-0.00292899536455400;-0.00292163063726552;-0.00292834553567561;-0.00295693800632500;-0.00293939262660833;-0.00293679331109475;-0.00296560239137027;-0.00295542173894208;-0.00294307499025257;-0.00293636009184248;-0.00292617943941429;-0.00293159468006758;-0.00296776848763159;-0.00295650478707274;-0.00295260581380237;-0.00298293116146082;-0.00298466403846987;-0.00298011523632110;-0.00297578304379847;-0.00296105358922151;-0.00295650478707274;-0.00298401420959147;-0.00298141489407789;-0.00298076506519950;-0.00301000736472729;-0.00300589178183078;-0.00299246198501061;-0.00298401420959147;-0.00297080102239744;-0.00296451934323961;-0.00298899623099251;-0.00297643287267686;-0.00295997054109085;-0.00298899623099251;-0.00300372568556947;-0.00301000736472729;-0.00300567517220465;-0.00299007927912316;-0.00297599965342460;-0.00300004332192523;-0.00300459212407399;-0.00300025993155136;-0.00300849109734437;-0.00300004332192523;-0.00298293116146082;-0.00297621626305073;-0.00296733526837933;-0.00295910410258632;-0.00297405016678941;-0.00298271455183468;-0.00298683013473119;-0.00299246198501061;-0.00299376164276740;-0.00299007927912316;-0.00295888749296019;-0.00292682926829268;-0.00289563748212971;-0.00291751505436902;-0.00293072824156305;-0.00293614348221635;-0.00293614348221635;-0.00294394142875709;-0.00295953732183858;-0.00294025906511285;-0.00291989776025647;-0.00289888662652168;-0.00287960836979595;-0.00286227959970541;-0.00284733353550232;-0.00283910236970931;-0.00283563661569120;-0.00283758610232639;-0.00285123250877269;-0.00287202703288134;-0.00290191916128753;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724;-0.00290473508642724];
    young.t = 0:0.001:1;
    old.v = [-0.00453781512605042;-0.00385087049173736;-0.00241365445699811;-0.000193615053676973;0.00365003417634997;0.00854649993968879;0.0145987294439307;0.0235655984881991;0.0337139640545213;0.0451610309195449;0.0595251497728278;0.0754935467009770;0.0933597362389932;0.113145832495678;0.134156246230550;0.156704595713884;0.180851192151502;0.205540589441518;0.230770777210406;0.257307707772104;0.284266816774557;0.311648104217764;0.339330947690081;0.367134413574042;0.395098709340195;0.422761449077239;0.450162840255720;0.477061638052350;0.503136182702746;0.528868963853484;0.554219774034016;0.578927264685779;0.603172369426239;0.626653532226288;0.649149611997909;0.671062683446584;0.692131398013751;0.711571710023722;0.730147561416911;0.747698122311125;0.764384222588557;0.780467210807768;0.795585219733827;0.809939286719472;0.823851071529090;0.837260262956857;0.849242089180170;0.860439869727795;0.870974227011379;0.881066302118934;0.890796509991556;0.899662257247397;0.907502714004262;0.914800369908729;0.922077922077922;0.929074021953279;0.935869084475896;0.942483213381046;0.948192674198866;0.953278919223192;0.957902778336215;0.962164770214306;0.966165413533834;0.969804189618431;0.973382654497206;0.976900808170158;0.979976679667082;0.982630372723252;0.984942302279763;0.987113505689357;0.988842426922922;0.990209480921555;0.991998713360943;0.993647219653411;0.995094688593141;0.996160186562663;0.996984439708898;0.997607655502392;0.998753568413011;0.999577821559246;1;0.999859273853082;0.999517510353424;0.998954605765751;0.998472116119175;0.997848900325680;0.997004543444172;0.995577178239717;0.994049294358892;0.992440995536971;0.990872904185598;0.988983153069840;0.986490289895862;0.983514937075309;0.980579791725303;0.977825579992763;0.975051264524949;0.972096015439669;0.968698484178360;0.965260745446504;0.962044147802662;0.959350247275944;0.955912508544088;0.952112902577299;0.947850910699208;0.943769852438583;0.939889831530698;0.936532507739938;0.932773109243697;0.928692050983073;0.924068191870049;0.920228378432713;0.916609706083390;0.912910618792972;0.908909975473443;0.904828917212818;0.900928792569659;0.896908045514857;0.892826987254232;0.888745928993607;0.884705078203530;0.880684331148727;0.876422339270636;0.872039724980901;0.867616903220618;0.863495637489446;0.859314060552451;0.855031964939086;0.850247275943870;0.845623416830847;0.841160387600016;0.837461300309597;0.833018374814040;0.828092959671907;0.823408789353062;0.819347834827711;0.815709058743114;0.810502191307145;0.805516464959189;0.800751879699248;0.796550199026979;0.791705198825942;0.786216879096136;0.781432190100921;0.776526878694061;0.771521048610832;0.765650757910820;0.759880985887178;0.754231836275180;0.748703309074826;0.743194885609746;0.737666358409392;0.731816171444654;0.726207229303205;0.720980258131961;0.715793494431265;0.710325278436734;0.704414780266173;0.699630091270958;0.695026335893209;0.690462787986008;0.685135298138394;0.680149571790439;0.675887579912348;0.671866832857545;0.667685255920550;0.663182019219171;0.659161272164368;0.655100317639017;0.650798118290378;0.646877889911946;0.643158698886253;0.639700856419123;0.635680109364320;0.631679466044791;0.628101001166017;0.625125648345463;0.622170399260183;0.618792971734148;0.615073780708456;0.611515419564955;0.608841622773511;0.606107514776245;0.603112058220417;0.599292348518355;0.595512846286840;0.591974588878614;0.589381207028266;0.586184713119698;0.582606248240923;0.578505086245024;0.575027140042620;0.571790438663504;0.568332596196373;0.564412367817941;0.560230790880946;0.555828072855937;0.551787222065860;0.547947408628523;0.543946765308994;0.539724980901451;0.535362470346991;0.531341723292188;0.527119938884645;0.522777532065458;0.518636162599011;0.514514896867838;0.510373527401391;0.505709460817820;0.501025290498975;0.496381327650677;0.492682240360259;0.488500663423264;0.483917011780789;0.479212737726670;0.474850227172209;0.470789272646858;0.466286035945479;0.461581761891359;0.456656346749226;0.452072695106751;0.447830806963934;0.444031200997145;0.439206304531382;0.434401511800893;0.429697237746773;0.426118772867999;0.422057818342648;0.417232921876885;0.412387921675847;0.408045514856660;0.404507257448434;0.399601946041575;0.394455389811427;0.389248522375457;0.385167464114833;0.380905472236742;0.375980057094608;0.370592256041172;0.365526114752121;0.361324434079852;0.356620160025733;0.351554018736681;0.345904869124683;0.341220698805838;0.336697358369185;0.331912669373970;0.326404245908890;0.320956133649632;0.316332274536609;0.311547585541394;0.306521651722890;0.300952917051988;0.295826464557115;0.290901049414981;0.286156567890314;0.281030115395440;0.275702625547827;0.270234409553295;0.265268786940614;0.260242853122110;0.253910176510796;0.247879055928592;0.242008765228579;0.236058059587471;0.229524345623417;0.222588556953882;0.215331108519963;0.208274697438784;0.201157975151783;0.192991837883479;0.184801576132845;0.176567086164609;0.168010936431989;0.158560170479675;0.148516344336778;0.138936914478710;0.129369546861807;0.119770013268465;0.109492983796389;0.0990872904185598;0.0885408708938121;0.0769852438583089;0.0655783844638334;0.0542941578545294;0.0421776366048812;0.0300068352699932;0.0177811507378071;0.00536890354227815;-0.00709078846849745;-0.0195995335933416;-0.0329841984640746;-0.0458204334365325;-0.0579771621567287;-0.0687547746371276;-0.0790639700856419;-0.0888725825258333;-0.0972196534116039;-0.104348437939769;-0.109927224478308;-0.113222226689719;-0.115618591934381;-0.116999718547706;-0.116481042177637;-0.115059708093764;-0.112546741184512;-0.109428651843513;-0.105580796912066;-0.100570946081782;-0.0950484500020104;-0.0896425555868280;-0.0846709018535644;-0.0792750593060191;-0.0739495798319328;-0.0689799364721965;-0.0649330545615375;-0.0607776124803989;-0.0557878653853886;-0.0506111535523300;-0.0455349603956415;-0.0408729041855977;-0.0360701218286358;-0.0312552772305094;-0.0265268786940614;-0.0224820071569298;-0.0188152868803024;-0.0156041172449841;-0.0124239073619879;-0.00944775039202284;-0.00721362229102167;-0.00567850106549797;-0.00442945599292349;-0.00308733062603032;-0.00231233163121708;-0.00197322182461501;-0.00246009408548108;-0.00260866068915605;-0.00261690322061839;-0.00286639057536890;-0.00340074785895219;-0.00400144746893973;-0.00387459289936070;-0.00381528688030236;-0.00380463190060713;-0.00384383418439146;-0.00383860721322022;-0.00380845161030920;-0.00384664870732982;-0.00385710264967231;-0.00384745285674078;-0.00384624663262434;-0.00383338024204897;-0.00381307546942222;-0.00384504040850790;-0.00384524144586064;-0.00381749829118250;-0.00384865908085722;-0.00385308190261751;-0.00383136986852157;-0.00382795223352499;-0.00381830244059346;-0.00380181737766877;-0.00383921032527844;-0.00384323107233324;-0.00380644123678179;-0.00383941136263118;-0.00385971613525793;-0.00385971613525793;-0.00384584455791886;-0.00382654497205581;-0.00380141530296329;-0.00383418439145993;-0.00385348397732299;-0.00384363314703872;-0.00386876281613124;-0.00389429455992923;-0.00391278999638133;-0.00388967070081621;-0.00385690161231957;-0.00381790036588798;-0.00381790036588798;-0.00382352941176471;-0.00382533874793937;-0.00383197298057979;-0.00383317920469623;-0.00382031281412086;-0.00378694061356600;-0.00374653210566523;-0.00370170077600418;-0.00371135056893571;-0.00372743355715492;-0.00372039724980901;-0.00372502110892204;-0.00374009891037755;-0.00377568252181255;-0.00377286799887419;-0.00375598086124402;-0.00373627920067549;-0.00374291343331591;-0.00376261509388444;-0.00379297173414820;-0.00378251779180572;-0.00376080575770978;-0.00376764102770295;-0.00375598086124402;-0.00373788749949741;-0.00373225845362068;-0.00372140243657271;-0.00371094849423023;-0.00371778376422339;-0.00371718065216517;-0.00371738168951791;-0.00375356841301114;-0.00375135700213100;-0.00372642837039122;-0.00371376301716859;-0.00371959310039805;-0.00374029994773029;-0.00378794580032970;-0.00379578625708657;-0.00377749185798721;-0.00381086405854208;-0.00381428169353866;-0.00379397692091191;-0.00378714165091874;-0.00377286799887419;-0.00375336737565840;-0.00378513127739134;-0.00379297173414820;-0.00377729082063447;-0.00381247235736400;-0.00381729725382976;-0.00378995617385710;-0.00377347111093241;-0.00376362028064814;-0.00376160990712074;-0.00379638936914479;-0.00380081219090507;-0.00376502754211733;-0.00380061115355233;-0.00381830244059346;-0.00380463190060713;-0.00380443086325439;-0.00379819870531945;-0.00378111053033654;-0.00381247235736400;-0.00382252422500100;-0.00378915202444614;-0.00381488480559688;-0.00382996260705239;-0.00381046198383660;-0.00380905472236742;-0.00380523501266535;-0.00379096136062080;-0.00382011177676812;-0.00383478750351815;-0.00379880181737767;-0.00382332837441197;-0.00384644766997708;-0.00383237505528527;-0.00382312733705923;-0.00381267339471674;-0.00379538418238109;-0.00382493667323389;-0.00385207671585381;-0.00383036468175787;-0.00385549435085039;-0.00388987173816895;-0.00390092879256966;-0.00389168107434361;-0.00387077318965864;-0.00383740098910378;-0.00384403522174420;-0.00386232962084355;-0.00385649953761409;-0.00386755659201480;-0.00387961883317920;-0.00385830887378875;-0.00383217401793253;-0.00380201841502151;-0.00376462546741185;-0.00376784206505569;-0.00378774476297696;-0.00376181094447348;-0.00376864621446665;-0.00379538418238109;-0.00382111696353182;-0.00382292629970649;-0.00380744642354549;-0.00378030638092558;-0.00378452816533312;-0.00381126613324756;-0.00382734912146677;-0.00382654497205581;-0.00381207028265852;-0.00380221945237425;-0.00378794580032970;-0.00376965140123035;-0.00375738812271320;-0.00375015077801455;-0.00374793936713441;-0.00373507297655904;-0.00373547505126452;-0.00374914559125085;-0.00378372401592216;-0.00379417795826465;-0.00377688874592899;-0.00375397048771662;-0.00374954766595633;-0.00376824413976117;-0.00379478107032287;-0.00379900285473041;-0.00377286799887419;-0.00378653853886052;-0.00378271882915846;-0.00374834144183989;-0.00372361384745286;-0.00369969040247678;-0.00367496280808974;-0.00368863334807607;-0.00369908729041856;-0.00369406135660006;-0.00372019621245627;-0.00373085119215150;-0.00370129870129870;-0.00368300430219935;-0.00367938562985003;-0.00370190181335692;-0.00374492380684331;-0.00377266696152145;-0.00375336737565840;-0.00377708978328173;-0.00379759559326123;-0.00378030638092558;-0.00377367214828515;-0.00376723895299747;-0.00375175907683648;-0.00377548148445981;-0.00379578625708657;-0.00376241405653170;-0.00377608459651803;-0.00379578625708657;-0.00377306903622693;-0.00376764102770295;-0.00376663584093925;-0.00375477463712758;-0.00377588355916529;-0.00380000804149411;-0.00376482650476459;-0.00377990430622010;-0.00381267339471674;-0.00379940492943589;-0.00379498210767561;-0.00379337380885369;-0.00377688874592899;-0.00379377588355916;-0.00382373044911745;-0.00378975513650436;-0.00379598729443931;-0.00382574082264485;-0.00381870451529894;-0.00380865264766194;-0.00379558521973383;-0.00376764102770295;-0.00377246592416871;-0.00380121426561055;-0.00378814683768244;-0.00380000804149411;-0.00383237505528527;-0.00381247235736400;-0.00379719351855575;-0.00378633750150778;-0.00376804310240843;-0.00378030638092558;-0.00382393148647019;-0.00380000804149411;-0.00380704434884001;-0.00385046841703188;-0.00386253065819629;-0.00386373688231273;-0.00385308190261751;-0.00382714808411403;-0.00382513771058663;-0.00385670057496683;-0.00385730368702505;-0.00385810783643601;-0.00386253065819629;-0.00384423625909694;-0.00382694704676129;-0.00381508584294962;-0.00380081219090507;-0.00379618833179205;-0.00380845161030920;-0.00378513127739134;-0.00377608459651803;-0.00380583812472357;-0.00382915845764143;-0.00383981343733666;-0.00382654497205581;-0.00380081219090507;-0.00379015721120984;-0.00382111696353182;-0.00383599372763459;-0.00384101966145310;-0.00383177194322705;-0.00381950866470990;-0.00380523501266535;-0.00378854891238792;-0.00377427526034337;-0.00376442443005911;-0.00376583169152829;-0.00377146073740501;-0.00377729082063447;-0.00377869808210365;-0.00378975513650436;-0.00379397692091191;-0.00375336737565840;-0.00371697961481243;-0.00369245305777813;-0.00371577339069599;-0.00374311447066865;-0.00376542961682281;-0.00374934662860359;-0.00375779019741868;-0.00377306903622693;-0.00374351654537413;-0.00371979413775079;-0.00370009247718226;-0.00368481363837401;-0.00369325720718910;-0.00371557235334325;-0.00372160347392546;-0.00374613003095975;-0.00377990430622010;-0.00375738812271320;-0.00374170720919947;-0.00373165534156246;-0.00372059828716175;-0.00373326364038438;-0.00376462546741185;-0.00373487193920630;-0.00374070202243577;-0.00377930119416188;-0.00376663584093925;-0.00375919745888786;-0.00375678501065498;-0.00374311447066865;-0.00375296530095292;-0.00378955409915162;-0.00375899642153512;-0.00375497567448032;-0.00378613646415504;-0.00376603272888103;-0.00375376945036388;-0.00375618189859676;-0.00374673314301797;-0.00375537774918580;-0.00379196654738450;-0.00376945036387761;-0.00376603272888103;-0.00380302360178521;-0.00378995617385710;-0.00377427526034337;-0.00376563065417555;-0.00375256322624744;-0.00375959953359334;-0.00380603916207631;-0.00379156447267902;-0.00378653853886052;-0.00382533874793937;-0.00382775119617225;-0.00382172007559004;-0.00381609102971332;-0.00379739455590849;-0.00379156447267902;-0.00382674600940855;-0.00382352941176471;-0.00382252422500100;-0.00386011820996341;-0.00385489123879217;-0.00383760202645652;-0.00382674600940855;-0.00380965783442564;-0.00380161634031603;-0.00383317920469623;-0.00381689517912428;-0.00379578625708657;-0.00383297816734349;-0.00385207671585381;-0.00386011820996341;-0.00385448916408669;-0.00383458646616541;-0.00381649310441880;-0.00384725181938804;-0.00385308190261751;-0.00384765389409352;-0.00385810783643601;-0.00384725181938804;-0.00382533874793937;-0.00381689517912428;-0.00380523501266535;-0.00379478107032287;-0.00381387961883318;-0.00382493667323389;-0.00383036468175787;-0.00383760202645652;-0.00383921032527844;-0.00383438542881267;-0.00379458003297013;-0.00375336737565840;-0.00371336094246311;-0.00374130513449399;-0.00375839330947690;-0.00376542961682281;-0.00376542961682281;-0.00377548148445981;-0.00379538418238109;-0.00377045555064131;-0.00374452173213783;-0.00371758272687065;-0.00369285513248362;-0.00367074102368220;-0.00365144143781915;-0.00364098749547666;-0.00363636363636364;-0.00363897712194926;-0.00365646737163765;-0.00368320533955209;-0.00372140243657271;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478;-0.00372522214627478];
    old.t = young.t;
%     current_dir = cd;
%     up.PATHS.scripts.ORourke = 'C:\Documents\Google Drive\Work\Code\old_Haemodynamic_Tools_v4\GenerateInputFiles\ParametricInflow\ORourke_inflows\';
%     cd(up.PATHS.scripts.ORourke)
%     old_tmp = load('orourke2009_old_modified5.dat');
%     old.v = old_tmp(2,:)'./max(old_tmp(2,:));
%     old.t = old_tmp(1,:)';
%     young_tmp = load('orourke2009_young_modified5.dat');
%     young.v = young_tmp(2,:)'./max(young_tmp(2,:));
%     young.t = young_tmp(1,:)';
%     cd(current_dir)
    
    % setup figure
    figure(1);
    paper_size = [560 420];
    set(figure(1),'Position',[0 400 paper_size])
    set(gca,'fontsize',16)
    xlabel('time [s]')
    ylabel('Q/Qmax')
    hold on
    
    % plot relevant points for different types of flow wave
    switch template_flow.age
        case 'young'
            rel_wave = young;
        case 'elderly'
            rel_wave = old;
        case 'avg'
            rel_wave = mean([young.v, old.v], 2);
    end
    plot(old.t,rel_wave.v,'r','linewidth',3);
    plot(template_flow.t,template_flow.v,'--b','linewidth',2)
    plot(inflow.t, inflow.v/max(inflow.v), 'k','linewidth',2)
    plot(old.t(end), rel_wave.v(end), 'or')
    plot(template_flow.t(end),template_flow.v(end), '*b');
    plot(inflow.t(end),inflow.v(end)/max(inflow.v), '*k');
    legend('O Rourke','Template','Generated')
    if ~strcmp(template_flow.age, 'young')
        plot(template_flow.ti2_0,template_flow.Qi2,'*b');
    end
    plot(template_flow.tmax_0,template_flow.Qmax,'*b')
    plot(template_flow.ti_0,template_flow.Qi,'*b')
    [~, rel_el] = min(abs(template_flow.t - template_flow.ts_0));
    plot(template_flow.ts_0,template_flow.v(rel_el),'*b')
    plot(template_flow.td_0,0,'*b')
    title(['Comparison of ' template_flow.age ' waveform with O''Rourke''s'], 'FontSize', 14)
    ylim([-0.2 1.1])
    
    save_processing_plot = false;
    if save_processing_plot
        if params.save_plot
            filename = [params.plot_name, '_process'];
            save_plot(gcf, paper_size, filename, params.file_path)
        end
    end
    
    % Final inflow waveform in ml/s
    
    figure(2)
    set(figure(2),'Position',[600 400 paper_size])
    set(gca,'fontsize',16)
    hold on
    plot(inflow.t,inflow.v*1e6,'k','linewidth',2);
    ylabel('Q [ml/s]')
    xlabel('time [s]')
    %title('Generated Aortic Flow Wave','FontSize',14)
    
    %- adjust color if multiple plots
    if params.plot_multiple
        h_lines = findall(gcf, 'Type', 'line');
        color_range = [0,0.75];
        if length(h_lines) > 1
            rel_colors = linspace(color_range(1), color_range(2), length(h_lines));
            for s = 1 : length(h_lines)
                h_lines(s).Color = rel_colors(s)*[1,1,1];
            end
        end      
    end
    
    if params.save_plot
        save_plot(gcf, paper_size, params.plot_name, params.file_path)
    end
    
end
end

function save_plot(h_fig, paper_size, filename, filepath)

savepath = [filepath, filename];
set(gcf,'color','w');
set(gcf,'PaperUnits','centimeters');
set(gcf,'PaperSize', [paper_size(1), paper_size(2)]./40);
set(gcf,'PaperPosition',[0 0 paper_size(1) paper_size(2)]./40);
print(gcf,'-dpdf',savepath)
print(gcf,'-dpng',savepath)

end
